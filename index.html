<!DOCTYPE html>
<html lang="en" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hourly Cost Calculator</title>
    <style>
        body { 
            font-family: system-ui, sans-serif; 
            background-color: #f4f4f9; 
            padding: 20px; 
            margin: 0;
        }
        .app-wrapper {
            max-width: 500px;
            margin: auto;
        }
        /* Tab Bar Styles */
        .tab-bar {
            display: flex;
            overflow-x: auto;
            background-color: #dcdcdc;
            padding: 10px 10px 0 10px;
            border-radius: 8px 8px 0 0;
            gap: 5px;
        }
        .tab-btn {
            padding: 10px 15px;
            background-color: #e9ecef;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
            white-space: nowrap;
        }
        .tab-btn:hover { background-color: #f8f9fa; }
        .tab-btn.active {
            background-color: #ffffff;
            font-weight: bold;
            color: #000;
            border-top: 3px solid #0056b3;
        }
        .btn-add-tab {
            background-color: #28a745;
            color: white;
            font-weight: bold;
            padding: 10px 15px;
        }
        .btn-add-tab:hover { background-color: #218838; }

        /* Calculator Container Styles */
        .container { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 0 0 8px 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .header-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .header-controls input {
            margin: 0;
            flex-grow: 1;
            font-size: 1em;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .btn-lang {
            background-color: #6c757d;
            width: auto;
            margin: 0;
            padding: 8px 12px;
            white-space: nowrap;
        }
        .btn-lang:hover { background-color: #5a6268; }
        label, .input-field { 
            display: block; 
            width: 100%; 
            margin-bottom: 12px; 
            box-sizing: border-box;
        }
        .input-field { 
            padding: 8px; 
            margin-top: 4px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        button { 
            width: 100%; 
            padding: 10px; 
            margin-top: 10px; 
            background-color: #0056b3; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
        }
        button:hover { background-color: #004494; }
        .btn-calc-add { background-color: #28a745; }
        .btn-calc-add:hover { background-color: #218838; }
        .btn-pay { background-color: #6f42c1; margin-top: 20px; }
        .btn-pay:hover { background-color: #59339d; }
        
        .result-box { 
            font-weight: bold; 
            margin: 15px 0; 
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: center;
        }
        ul { list-style-type: none; padding: 0; }
        
        /* Updated List Item Styles for Bi-Directional Support */
        li { 
            background: #f8f9fa; 
            margin: 5px 0; 
            padding: 10px; 
            border-inline-start: 4px solid #0056b3; 
            border-radius: 3px; 
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8em;
            width: auto;
            margin: 0;
        }
        .btn-delete:hover { background-color: #c82333; }
        
        .payment-record { border-inline-start: 4px solid #6f42c1; background: #f4f0fa; }
        .total-box {
            font-size: 1.2em;
            font-weight: bold;
            text-align: end; /* Adapts to RTL automatically */
            margin-top: 20px;
            color: #d9534f;
        }
        hr { border: 0; height: 1px; background: #ddd; margin: 25px 0; }
        .btn-clear-data {
            background-color: #dc3545;
            margin-top: 10px;
            font-size: 0.8em;
            padding: 8px;
        }
        .btn-clear-data:hover { background-color: #c82333; }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="tab-bar" id="tabBar"></div>

        <div class="container">
            <div class="header-controls">
                <input type="text" id="tabNameInput" placeholder="Name this project..." onkeyup="updateTabName()">
                <button class="btn-lang" onclick="toggleLanguage()">עברית / EN</button>
            </div>
            
            <label id="lblDate">Date: <input type="date" id="calcDate" class="input-field"></label>
            <label id="lblStart">Start Time: <input type="time" id="startTime" class="input-field"></label>
            <label id="lblEnd">End Time: <input type="time" id="endTime" class="input-field"></label>
            <label id="lblTariff">Tariff per Hour (₪): <input type="number" id="tariff" class="input-field" min="0" step="0.01"></label>

            <button id="btnCalc" onclick="calculateCost()">Calculate</button>
            <div class="result-box" id="currentCostDisplay">---</div>
            <button id="btnAdd" class="btn-calc-add" onclick="addToList()">Add to List</button>

            <h3 id="hdrRecorded">Recorded Costs</h3>
            <ul id="costList"></ul>
            <div class="total-box" id="totalCostDisplay">Total Cost: ₪0.00</div>

            <button id="btnPay" class="btn-pay" onclick="processPayment()">Mark as Paid</button>

            <hr>
            
            <h3 id="hdrHistory">Payment History</h3>
            <ul id="paymentList"></ul>
            
            <button id="btnReset" class="btn-clear-data" onclick="hardReset()">⚠️ Factory Reset App</button>
        </div>
    </div>

    <script>
        // --- TRANSLATION DICTIONARY ---
        const dict = {
            en: {
                tabPlaceholder: "Name this project...",
                lblDate: "Date:",
                lblStart: "Start Time:",
                lblEnd: "End Time:",
                lblTariff: "Tariff per Hour (₪):",
                btnCalc: "Calculate",
                btnAdd: "Add to List",
                hdrRecorded: "Recorded Costs",
                btnPay: "Mark as Paid",
                hdrHistory: "Payment History",
                btnReset: "⚠️ Factory Reset App",
                newTab: "+ New Tab",
                btnDelete: "Delete",
                totalPrefix: "Total Cost: ₪",
                calcPrefix: "Current Calculation: ",
                hrs: "hrs",
                projectPrefix: "Project ",
                paidText: "Paid ₪",
                onText: " on ",
                errFill: "Please fill in all fields correctly.",
                errCalcFirst: "Please calculate a cost first.",
                errNoPay: "There are no recorded costs to pay.",
                confDelete: "Delete this entry?",
                confPay: "Record a payment of ₪",
                confReset: "WARNING: This will delete ALL tabs, lists, and payment history forever. Are you absolutely sure?"
            },
            he: {
                tabPlaceholder: "שם הפרויקט...",
                lblDate: "תאריך:",
                lblStart: "שעת התחלה:",
                lblEnd: "שעת סיום:",
                lblTariff: "תעריף לשעה (₪):",
                btnCalc: "חשב",
                btnAdd: "הוסף לרשימה",
                hdrRecorded: "עלויות שנרשמו",
                btnPay: "סמן כשולם",
                hdrHistory: "היסטוריית תשלומים",
                btnReset: "⚠️ איפוס אפליקציה",
                newTab: "+ כרטיסייה חדשה",
                btnDelete: "מחק",
                totalPrefix: "סך הכל עולה: ₪",
                calcPrefix: "חישוב נוכחי: ",
                hrs: "שעות",
                projectPrefix: "פרויקט ",
                paidText: "שולם ₪",
                onText: " בתאריך ",
                errFill: "אנא מלא את כל השדות כראוי.",
                errCalcFirst: "אנא חשב עלות תחילה.",
                errNoPay: "אין עלויות רשומות לתשלום.",
                confDelete: "למחוק רשומה זו?",
                confPay: "לרשום תשלום של ₪",
                confReset: "אזהרה: פעולה זו תמחק את כל הכרטיסיות והיסטוריית התשלומים לצמיתות. האם אתה בטוח?"
            }
        };

        // --- DATA & STATE MANAGEMENT ---
        let appState = {
            language: 'en', // New language state
            activeTabId: 1,
            nextTabId: 2,
            tabs: [{ id: 1, name: "Project 1", costs: [], payments: [], total: 0 }]
        };

        let currentPendingCost = { amount: 0, details: "" };

        function saveState() {
            localStorage.setItem('myHourlyCalculatorData', JSON.stringify(appState));
        }

        function loadState() {
            const savedData = localStorage.getItem('myHourlyCalculatorData');
            if (savedData) {
                appState = JSON.parse(savedData);
                // Ensure language property exists for older saves
                if (!appState.language) appState.language = 'en'; 
            }
        }

        function hardReset() {
            const t = dict[appState.language];
            if (confirm(t.confReset)) {
                localStorage.removeItem('myHourlyCalculatorData');
                location.reload(); 
            }
        }

        // --- LANGUAGE LOGIC ---
        function toggleLanguage() {
            appState.language = appState.language === 'en' ? 'he' : 'en';
            saveState();
            applyLanguage();
        }

        function applyLanguage() {
            const lang = appState.language;
            const t = dict[lang];

            // Set layout direction (RTL for Hebrew, LTR for English)
            document.getElementById('htmlRoot').dir = lang === 'he' ? 'rtl' : 'ltr';

            // Update static HTML elements
            document.getElementById('tabNameInput').placeholder = t.tabPlaceholder;
            document.getElementById('lblDate').childNodes[0].nodeValue = t.lblDate + " ";
            document.getElementById('lblStart').childNodes[0].nodeValue = t.lblStart + " ";
            document.getElementById('lblEnd').childNodes[0].nodeValue = t.lblEnd + " ";
            document.getElementById('lblTariff').childNodes[0].nodeValue = t.lblTariff + " ";
            document.getElementById('btnCalc').innerText = t.btnCalc;
            document.getElementById('btnAdd').innerText = t.btnAdd;
            document.getElementById('hdrRecorded').innerText = t.hdrRecorded;
            document.getElementById('btnPay').innerText = t.btnPay;
            document.getElementById('hdrHistory').innerText = t.hdrHistory;
            document.getElementById('btnReset').innerText = t.btnReset;

            // Redraw everything to catch dynamic translations
            renderTabs();
            renderActiveTabData();
            resetPendingCost();
        }

        // --- SAFE INITIALIZATION ---
        function initializeApp() {
            loadState(); 
            applyLanguage(); // This will trigger renderTabs and renderActiveTabData
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // --- TAB LOGIC ---
        function renderTabs() {
            const tabBar = document.getElementById('tabBar');
            if (!tabBar) return; 
            const t = dict[appState.language];
            tabBar.innerHTML = ''; 

            appState.tabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn' + (tab.id === appState.activeTabId ? ' active' : '');
                
                // Translate default "Project X" names dynamically
                let displayName = tab.name;
                if (tab.name.startsWith("Project ") || tab.name.startsWith("פרויקט ")) {
                    displayName = t.projectPrefix + tab.id;
                }
                btn.innerText = displayName;
                
                btn.onclick = function() { switchTab(tab.id); };
                tabBar.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'tab-btn btn-add-tab';
            addBtn.innerText = t.newTab;
            addBtn.onclick = createNewTab;
            tabBar.appendChild(addBtn);
        }

        function createNewTab() {
            const newId = appState.nextTabId++;
            appState.tabs.push({
                id: newId,
                name: "Project " + newId,
                costs: [], payments: [], total: 0
            });
            saveState(); 
            switchTab(newId);
        }

        function switchTab(id) {
            appState.activeTabId = id;
            saveState(); 
            
            resetPendingCost();
            document.getElementById('calcDate').value = "";
            document.getElementById('startTime').value = "";
            document.getElementById('endTime').value = "";
            document.getElementById('tariff').value = "";
            
            renderTabs();
            renderActiveTabData();
        }

        function updateTabName() {
            const newName = document.getElementById('tabNameInput').value;
            let activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if(!activeTab) return;
            
            if (newName.trim() !== "") {
                activeTab.name = newName;
                document.title = newName; 
            } else {
                activeTab.name = "Project " + activeTab.id;
                document.title = "Hourly Cost Calculator";
            }
            saveState(); 
            renderTabs();
        }

        function renderActiveTabData() {
            let activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if(!activeTab) return;
            const t = dict[appState.language];
            
            // Handle project name placeholder logic
            if (activeTab.name.startsWith("Project ") || activeTab.name.startsWith("פרויקט ")) {
                document.getElementById('tabNameInput').value = "";
            } else {
                document.getElementById('tabNameInput').value = activeTab.name;
            }

            const costList = document.getElementById('costList');
            costList.innerHTML = '';
            activeTab.costs.forEach(function(item, index) {
                const li = document.createElement('li');
                // Use a span for the text to flex-separate it from the button
                li.innerHTML = `<span>${item.details}</span> <button class="btn-delete" onclick="deleteLine(${index})">${t.btnDelete}</button>`;
                costList.appendChild(li);
            });

            const paymentList = document.getElementById('paymentList');
            paymentList.innerHTML = '';
            activeTab.payments.forEach(function(payment) {
                const li = document.createElement('li');
                li.className = 'payment-record';
                li.innerText = payment;
                paymentList.appendChild(li);
            });

            document.getElementById('totalCostDisplay').innerText = t.totalPrefix + activeTab.total.toFixed(2);
        }

        function resetPendingCost() {
            const t = dict[appState.language];
            currentPendingCost = { amount: 0, details: "" };
            document.getElementById('currentCostDisplay').innerText = t.calcPrefix + "0.00 " + t.hrs + " = ₪0.00";
        }

        // --- CALCULATOR LOGIC ---
        function calculateCost() {
            const t = dict[appState.language];
            const date = document.getElementById('calcDate').value;
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const tariff = parseFloat(document.getElementById('tariff').value);

            if (!date || !start || !end || isNaN(tariff)) {
                alert(t.errFill);
                return;
            }

            const startParts = start.split(':');
            const endParts = end.split(':');
            
            const startDecimal = parseInt(startParts[0], 10) + (parseInt(startParts[1], 10) / 60);
            const endDecimal = parseInt(endParts[0], 10) + (parseInt(endParts[1], 10) / 60);
            
            let diffHours = endDecimal - startDecimal;
            if (diffHours < 0) diffHours += 24; 

            const cost = diffHours * tariff;
            
            currentPendingCost = {
                amount: cost,
                details: `${date} | ${start} - ${end} (${diffHours.toFixed(2)} ${t.hrs}) | ₪${cost.toFixed(2)}`
            };
            
            document.getElementById('currentCostDisplay').innerText = t.calcPrefix + diffHours.toFixed(2) + " " + t.hrs + " = ₪" + cost.toFixed(2);
        }

        function addToList() {
            const t = dict[appState.language];
            if (currentPendingCost.amount === 0) {
                alert(t.errCalcFirst);
                return;
            }

            let activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if(!activeTab) return;
            
            activeTab.costs.push({
                amount: currentPendingCost.amount,
                details: currentPendingCost.details
            });
            activeTab.total += currentPendingCost.amount;

            resetPendingCost();
            saveState(); 
            renderActiveTabData();
        }

        function deleteLine(index) {
            const t = dict[appState.language];
            if (confirm(t.confDelete)) {
                let activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                
                activeTab.total -= activeTab.costs[index].amount;
                if (activeTab.total < 0.01) activeTab.total = 0; 
                
                activeTab.costs.splice(index, 1);
                
                saveState(); 
                renderActiveTabData();
            }
        }

        function processPayment() {
            const t = dict[appState.language];
            let activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            
            if (activeTab.total === 0) {
                alert(t.errNoPay);
                return;
            }

            if (confirm(t.confPay + activeTab.total.toFixed(2) + "?")) {
                const today = new Date().toLocaleDateString();
                const record = t.paidText + activeTab.total.toFixed(2) + t.onText + today;
                
                activeTab.payments.push(record);
                activeTab.costs = [];
                activeTab.total = 0;

                saveState(); 
                renderActiveTabData();
            }
        }
    </script>
</body>
</html>
