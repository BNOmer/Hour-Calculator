<!DOCTYPE html>
<html lang="en" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hourly Cost Calculator</title>
    <style>
        body { 
            font-family: system-ui, sans-serif; 
            background-color: #f4f4f9; 
            padding: 20px; 
            margin: 0;
        }
        .app-wrapper { max-width: 500px; margin: auto; }
        
        .tab-bar {
            display: flex;
            overflow-x: auto;
            background-color: #dcdcdc;
            padding: 10px 10px 0 10px;
            border-radius: 8px 8px 0 0;
            gap: 5px;
        }
        .tab-btn {
            padding: 10px 15px;
            background-color: #e9ecef;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
            white-space: nowrap;
        }
        .tab-btn:hover { background-color: #f8f9fa; }
        .tab-btn.active {
            background-color: #ffffff;
            font-weight: bold;
            color: #000;
            border-top: 3px solid #0056b3;
        }
        .btn-add-tab { background-color: #28a745; color: white; font-weight: bold; }
        .btn-add-tab:hover { background-color: #218838; }

        .container { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 0 0 8px 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .header-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            align-items: center;
        }
        .header-controls input {
            margin: 0;
            flex-grow: 1;
            font-size: 1em;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 80px;
        }
        .btn-lang {
            background-color: #6c757d;
            width: auto;
            margin: 0;
            padding: 8px 12px;
            white-space: nowrap;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-lang:hover { background-color: #5a6268; }
        
        .btn-delete-tab {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            width: auto;
            margin: 0;
            white-space: nowrap;
        }
        .btn-delete-tab:hover { background-color: #c82333; }

        label, .input-field { 
            display: block; 
            width: 100%; 
            margin-bottom: 12px; 
            box-sizing: border-box;
        }
        .input-field { 
            padding: 8px; 
            margin-top: 4px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        button { 
            width: 100%; 
            padding: 10px; 
            margin-top: 10px; 
            background-color: #0056b3; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
        }
        button:hover { background-color: #004494; }
        .btn-calc-add { background-color: #28a745; }
        .btn-calc-add:hover { background-color: #218838; }
        .btn-pay { background-color: #6f42c1; margin-top: 20px; }
        .btn-pay:hover { background-color: #59339d; }
        
        .result-box { 
            font-weight: bold; 
            margin: 15px 0; 
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: center;
        }
        ul { list-style-type: none; padding: 0; }
        
        li { 
            background: #f8f9fa; 
            margin: 5px 0; 
            padding: 10px; 
            border-inline-start: 4px solid #0056b3; 
            border-radius: 3px; 
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8em;
            width: auto;
            margin: 0;
        }
        .btn-delete:hover { background-color: #c82333; }
        
        .payment-record { border-inline-start: 4px solid #6f42c1; background: #f4f0fa; }
        .total-box {
            font-size: 1.2em;
            font-weight: bold;
            text-align: end; 
            margin-top: 20px;
            color: #d9534f;
        }
        hr { border: 0; height: 1px; background: #ddd; margin: 25px 0; }
        .btn-clear-data {
            background-color: #dc3545;
            margin-top: 10px;
            font-size: 0.8em;
            padding: 8px;
        }
        .btn-clear-data:hover { background-color: #c82333; }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="tab-bar" id="tabBar"></div>
        <div class="container">
            <div class="header-controls">
                <input type="text" id="tabNameInput" placeholder="Name this project..." onkeyup="updateTabName()">
                <button id="btnDeleteTab" class="btn-delete-tab" onclick="deleteCurrentTab()">Delete</button>
                <button class="btn-lang" onclick="toggleLanguage()">עברית/EN</button>
            </div>
            
            <label><span id="txtDate">Date:</span> <input type="date" id="calcDate" class="input-field"></label>
            <label><span id="txtStart">Start Time:</span> <input type="time" id="startTime" class="input-field"></label>
            <label><span id="txtEnd">End Time:</span> <input type="time" id="endTime" class="input-field"></label>
            <label><span id="txtTariff">Tariff per Hour (₪):</span> <input type="number" id="tariff" class="input-field" min="0" step="0.01"></label>

            <button id="btnCalc" onclick="calculateCost()">Calculate</button>
            <div class="result-box" id="currentCostDisplay">---</div>
            <button id="btnAdd" class="btn-calc-add" onclick="addToList()">Add to List</button>

            <h3 id="hdrRecorded">Recorded Costs</h3>
            <ul id="costList"></ul>
            <div class="total-box" id="totalCostDisplay">Total Cost: ₪0.00</div>

            <button id="btnPay" class="btn-pay" onclick="processPayment()">Mark as Paid</button>

            <hr>
            
            <h3 id="hdrHistory">Payment History</h3>
            <ul id="paymentList"></ul>
            
            <button id="btnReset" class="btn-clear-data" onclick="hardReset()">⚠️ Factory Reset App</button>
        </div>
    </div>

    <script>
        const dict = {
            en: {
                tabPlaceholder: "Name this project...",
                lblDate: "Date:",
                lblStart: "Start Time:",
                lblEnd: "End Time:",
                lblTariff: "Tariff per Hour (₪):",
                btnCalc: "Calculate",
                btnAdd: "Add to List",
                hdrRecorded: "Recorded Costs",
                btnPay: "Mark as Paid",
                hdrHistory: "Payment History",
                btnReset: "⚠️ Factory Reset App",
                newTab: "+ New Tab",
                btnDelete: "Delete",
                btnDeleteTab: "Delete Tab",
                totalPrefix: "Total Cost: ₪",
                calcPrefix: "Current Calculation: ",
                hrs: "hrs",
                projectPrefix: "Project ",
                paidText: "Paid ₪",
                onText: " on ",
                errFill: "Please fill in all fields correctly.",
                errCalcFirst: "Please calculate a cost first.",
                errNoPay: "There are no recorded costs to pay.",
                errLastTab: "You cannot delete the last remaining tab.",
                confDelete: "Delete this entry?",
                confDeleteTab: "Are you sure you want to delete this entire project?",
                confPay: "Record a payment of ₪",
                confReset: "WARNING: This will delete ALL data. Are you sure?",
                askCal: "Would you like to add this payment to Google Calendar?"
            },
            he: {
                tabPlaceholder: "שם הפרויקט...",
                lblDate: "תאריך:",
                lblStart: "שעת התחלה:",
                lblEnd: "שעת סיום:",
                lblTariff: "תעריף לשעה (₪):",
                btnCalc: "חשב",
                btnAdd: "הוסף לרשימה",
                hdrRecorded: "עלויות שנרשמו",
                btnPay: "סמן כשולם",
                hdrHistory: "היסטוריית תשלומים",
                btnReset: "⚠️ איפוס אפליקציה",
                newTab: "+ כרטיסייה חדשה",
                btnDelete: "מחק",
                btnDeleteTab: "מחק פרויקט",
                totalPrefix: "סך הכל: ₪",
                calcPrefix: "חישוב נוכחי: ",
                hrs: "שעות",
                projectPrefix: "פרויקט ",
                paidText: "שולם ₪",
                onText: " בתאריך ",
                errFill: "אנא מלא את כל השדות כראוי.",
                errCalcFirst: "אנא חשב עלות תחילה.",
                errNoPay: "אין עלויות רשומות לתשלום.",
                errLastTab: "לא ניתן למחוק את הכרטיסייה האחרונה שנותרה.",
                confDelete: "למחוק רשומה זו?",
                confDeleteTab: "האם אתה בטוח שברצונך למחוק פרויקט זה?",
                confPay: "לרשום תשלום של ₪",
                confReset: "אזהרה: פעולה זו תמחק הכל. האם אתה בטוח?",
                askCal: "האם תרצה להוסיף את התשלום ליומן גוגל שלך?"
            }
        };

        let appState = {
            language: 'en',
            activeTabId: 1,
            nextTabId: 2,
            tabs: [{ id: 1, name: "Project 1", costs: [], payments: [], total: 0 }]
        };

        let currentPendingCost = { amount: 0, details: "" };

        function repairState() {
            if (!appState || typeof appState !== 'object') {
                appState = { language: 'en', activeTabId: 1, nextTabId: 2, tabs: [] };
            }
            if (appState.language !== 'en' && appState.language !== 'he') {
                appState.language = 'en';
            }
            if (!Array.isArray(appState.tabs) || appState.tabs.length === 0) {
                appState.tabs = [{ id: 1, name: "Project 1", costs: [], payments: [], total: 0 }];
                appState.activeTabId = 1;
                appState.nextTabId = 2;
            }
            
            let activeTabExists = false;
            for (let i = 0; i < appState.tabs.length; i++) {
                let t = appState.tabs[i];
                if (!t.name || typeof t.name !== 'string') t.name = "Project " + t.id;
                if (!Array.isArray(t.costs)) t.costs = [];
                if (!Array.isArray(t.payments)) t.payments = [];
                if (typeof t.total !== 'number') t.total = 0;
                if (t.id === appState.activeTabId) activeTabExists = true;
            }
            
            if (!activeTabExists) {
                appState.activeTabId = appState.tabs[0].id;
            }
        }

        function safeLoadState() {
            try {
                const savedData = localStorage.getItem('myHourlyCalculatorData');
                if (savedData) {
                    appState = JSON.parse(savedData);
                }
            } catch (e) {
                console.error("Data error. Resetting.", e);
                localStorage.removeItem('myHourlyCalculatorData');
            }
            repairState(); 
        }

        function initializeApp() {
            safeLoadState(); 
            applyLanguage(); 
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        function saveState() {
            try { localStorage.setItem('myHourlyCalculatorData', JSON.stringify(appState)); } 
            catch (e) { console.error("Save error:", e); }
        }

        function hardReset() {
            const t = dict[appState.language];
            if (confirm(t.confReset)) {
                localStorage.removeItem('myHourlyCalculatorData');
                window.location.reload(); 
            }
        }

        function toggleLanguage() {
            appState.language = appState.language === 'en' ? 'he' : 'en';
            saveState();
            applyLanguage();
        }

        function applyLanguage() {
            const lang = appState.language;
            const t = dict[lang];

            document.getElementById('htmlRoot').dir = lang === 'he' ? 'rtl' : 'ltr';

            document.getElementById('tabNameInput').placeholder = t.tabPlaceholder;
            
            document.getElementById('txtDate').innerText = t.lblDate;
            document.getElementById('txtStart').innerText = t.lblStart;
            document.getElementById('txtEnd').innerText = t.lblEnd;
            document.getElementById('txtTariff').innerText = t.lblTariff;
            
            document.getElementById('btnCalc').innerText = t.btnCalc;
            document.getElementById('btnAdd').innerText = t.btnAdd;
            document.getElementById('hdrRecorded').innerText = t.hdrRecorded;
            document.getElementById('btnPay').innerText = t.btnPay;
            document.getElementById('hdrHistory').innerText = t.hdrHistory;
            document.getElementById('btnReset').innerText = t.btnReset;
            document.getElementById('btnDeleteTab').innerText = t.btnDeleteTab;

            renderTabs();
            renderActiveTabData();
            resetPendingCost();
        }

        function renderTabs() {
            const tabBar = document.getElementById('tabBar');
            if (!tabBar) return; 
            const t = dict[appState.language];
            tabBar.innerHTML = ''; 

            appState.tabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn' + (tab.id === appState.activeTabId ? ' active' : '');
                
                let displayName = tab.name;
                if (tab.name.startsWith("Project ") || tab.name.startsWith("פרויקט ")) {
                    displayName = t.projectPrefix + tab.id;
                }
                btn.innerText = displayName;
                
                btn.onclick = function() { switchTab(tab.id); };
                tabBar.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'tab-btn btn-add-tab';
            addBtn.innerText = t.newTab;
            addBtn.onclick = createNewTab;
            tabBar.appendChild(addBtn);
        }

        function createNewTab() {
            const newId = appState.nextTabId++;
            appState.tabs.push({
                id: newId,
                name: "Project " + newId,
                costs: [], payments: [], total: 0
            });
            saveState(); 
            switchTab(newId);
        }

        function switchTab(id) {
            appState.activeTabId = id;
            saveState(); 
            
            resetPendingCost();
            document.getElementById('calcDate').value = "";
            document.getElementById('startTime').value = "";
            document.getElementById('endTime').value = "";
            document.getElementById('tariff').value = "";
            
            renderTabs();
            renderActiveTabData();
        }

        function deleteCurrentTab() {
            const t = dict[appState.language];
            if (appState.tabs.length <= 1) {
                alert(t.errLastTab);
                return;
            }
            if (confirm(t.confDeleteTab))
